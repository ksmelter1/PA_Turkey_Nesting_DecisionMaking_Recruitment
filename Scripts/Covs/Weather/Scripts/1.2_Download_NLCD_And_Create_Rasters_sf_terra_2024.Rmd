---
title: "1.2_Download_NLCD_And_Create_Rasters_sf_terra.R"
output: html_document
date: "2024-08-10"
---

Title:    Disease Modeling Software 
           Script "1.2_Download_NLCD_And_Create_Rasters_sf_terra" for Pennsylvania, USA

Authors:  Kristin J. Bondo, 
           Diego Montecino-Latorre, 
           W. David Walter
         
Date:    August 2024

Disclaimer: Any use of trade, firm, or product names is for descriptive purposes 
            only and does not imply endorsement by the U.S. Government.

Description: This script allows the user to download National Land Cover Class Data (NLCD) for the study area using a shapefile and the FedData Package. The output consists of an extracted NLCD raster of the study area for the year 2019 with 30m resolution. To use the FedData Package, be sure that Version 4.0 from GitHub is installed. Save the downloaded files to a location with a large amount of storage space because these files are large when downloaded over large extents.

This code was written under 
R version 4.2.1 (2022-06-23) -- "Funny-Looking Kid"
Copyright (C) 2020 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin17.0 (64-bit)

---

Set-up: Set the working directory on your computer to the location that you would like to store the downloaded files, generate the dataset, and run the models.
```{r}
#For mac
mac_path <- "/your_working_directory"  #Change code to the working directory on your computer
set_working_directory(mac_path)

#For PC
pc_path <- "C:/your_working_directory" #Change code to the working directory on your computer
set_working_directory(pc_path)

# Define working directory
working.directory <- getwd() # Set working directory

```

Set-up: If not done previously, run the project set-up code below to make folders and sub-folders to organize and save data in subsequent scripts.
```{r}

# 0/ Specify overall project folder "Spatial_Disease_Modeling" to contain project files                                           
dir.create(paste0(getwd(),"/Spatial_Disease_Modeling"))

# 1/ Make a sub-folder "1_Raw_Data" to store downloaded raw spatial data 
folder1 <- "Spatial_Disease_Modeling/1_Raw_Data"
dir.create(file.path(working.directory, folder1), recursive=TRUE)

# 2/ Make a sub-folder "2_Spatial_Data_Ready_To_Use" to store the rasters with desired resolution that will be used in the modeling #
folder2 <- "Spatial_Disease_Modeling/2_Spatial_Data_Ready_To_Use"
dir.create(file.path(working.directory, folder2), recursive=TRUE)

# 3/ Make a sub-folder "3_Data_Set_Prep" to store a copy of the cleaned data and extracted spatial data to attach to the dataset #
folder3 <- "Spatial_Disease_Modeling/3_Data_Set_Prep"
dir.create(file.path(working.directory, folder3), recursive=TRUE)

# 4/ Make a sub-folder "4_Run_INLA_Model" to store saved output of INLA models #
folder4 <- "Spatial_Disease_Modeling/4_Run_INLA_Models"
dir.create(file.path(working.directory, folder4), recursive=TRUE)

# 5/ Make a sub-folder "5_Predict_Surface" to store saved output of INLA models #
folder5 <- "Spatial_Disease_Modeling/5_Predict_Surface"
dir.create(file.path(working.directory, folder5), recursive=TRUE)

# 6/ Make a sub-folder "6_Visualize_in_Shiny" to store saved output of INLA models #
folder6 <- "Spatial_Disease_Modeling/6_Visualize_in_Shiny"
dir.create(file.path(working.directory, folder6), recursive=TRUE)

```

Set-Up: Check to see if required libraries are installed. If not, they will be installed.
```{r}

# List of required libraries
required_libraries <- c( "sf", "terra", "tigris")

# Function to check and install missing libraries
install_if_missing <- function(libraries) {
  for (lib in libraries) {
    if (!require(lib, character.only = TRUE)) {
      install.packages(lib, dependencies = TRUE)
    }
  }
}

# Install and load sf, terra, and tigris libraries if not installed
install_if_missing(required_libraries)

# Download Version 3.0 of the FedData Package and devtools from GitHub if not installed
remotes::install_github(repo = "r-lib/devtools", 
                              dependencies = TRUE, 
                              upgrade = TRUE)

devtools::install_github(repo = "r-lib/devtools",
                              dependencies = TRUE,
                              upgrade = TRUE)

#Install FedData package using devtools
install.packages("devtools")
devtools::install_github("ropensci/FedData")

```

Set-up: Load required packages once are already installed on your machine.
```{r}

library("sf")
library("terra")
library("tigris")
library("FedData") #Be sure to use Version 3.0 or greater from GitHub

sessionInfo() #Code to check whether Version 3.0 or greater of FedData is installed. If not correct version, then install from code above.

```

1) Create a template of the state of Pennsylvania with 5 km resolution and use this shapefile to download the NLCD raster in the next step. 
```{r}

# Download the shapefile of the study area, which is the state of Pennsylvania
states <- tigris::states(resolution = "5m",
                         class = "sf",
                         progress_bar = FALSE)

PA=states[states$STUSPS=="PA",]


# Project template as same coordinate system as NLCD layer
#template = st_buffer(st_transform(PA, st_crs(6562)), dist = 10000) # extend template boundary 10 km out from PA border
template = st_buffer(st_transform(PA, st_crs(5070)), dist = 10000) # extend template boundary 10 km out from PA border

plot(st_geometry(template))

#Code to save the template of the study area as a shapefile 
#st_write(obj=template, dsn=".", layer = "template", driver="ESRI Shapefile")   
                         
```

2) Using the FedData Package, download NLCD raster with 30 m resolution for the state of Pennsylvania using a shapefile of the study area.
```{r}
# Create a sub-folder to download raw and extracted elevation spatial data
sub_folder5 <- "Spatial_Disease_Modeling/1_Raw_Data/NLCD_Raw"
dir.create(file.path(working.directory, sub_folder5))

# Download raster of NLCD from the FedData package with 30 m resolution 
nlcd <- get_nlcd(template=template, 
                 year=2019, 
                 label = 'Pennsylvania', # Label does not seem to matter. Could also use 'Regional'
                 force.redo = T) 


# Check to see if the raster contains an NA values. 
na_count <- sum(is.na(values(nlcd)))
na_count

# If it contains NA values, will need to reclassify NA values to have a value of 0 in order to extract and link NLCD based on each landcover class in Script 2.3.

# Function to replace NA values with a specific value (e.g., 0)
replace_na_with_value <- function(raster_layer, replacement_value) {
  # Define a matrix with the NA values to replace
  lookup <- matrix(c(NA, replacement_value), ncol = 2, byrow = TRUE)
  colnames(lookup) <- c("from", "to")

  # Apply the function to replace NA values
  raster_layer_no_na <- classify(raster_layer, rcl = lookup, include.lowest = TRUE)
  
  return(raster_layer_no_na)
}

# Replace NA values with 0
nlcd_new <- replace_na_with_value(nlcd, 0)

# Verify replacement was successful
na_count <- sum(is.na(values(nlcd_new)))
na_count

plot(nlcd_new)

# Write the raster to disk
writeRaster(
  nlcd_new,
  file.path(working.directory, sub_folder5, "NLCD_2019.tif"),
  filetype = 'GTiff',
  datatype = 'INT1U',
  overwrite = TRUE
)


```

1) Load the NLCD landcover data and crop to the template of the study area
```{r}

# Create a sub-folder to store the downloaded NLCD .img file for year 2019
sub_folder5 <- "Spatial_Disease_Modeling/1_Raw_Data/NLCD_Raw"
dir.create(file.path(working.directory, sub_folder5))

# Load the NLCD .img file
nlcd <- rast(paste0(working.directory, "/", sub_folder5, "/", "nlcd_2019_land_cover_l48_20210604.img"))

# Inspect the raster
print(nlcd)

# Create a template of the study area by downloading a shapefile of the study area, which is the state of Pennsylvania
states <- tigris::states(resolution = "5m",
                         class = "sf",
                         progress_bar = FALSE)

PA=states[states$STUSPS=="PA",]

# Transform coordinate system to crs of nlcd and extend boundary out from PA border
template = st_buffer(st_transform(PA, st_crs(nlcd)), dist = 10000) # extend template boundary 10 km 

plot(st_geometry(template))

# Crop the raster to the shapefile's extent
nlcd_cropped <- crop(nlcd, template)

# Mask the cropped raster with the shapefile to get the exact area
nlcd_masked <- mask(nlcd_cropped, template)

plot(nlcd_masked)

# Write the raster to disk
writeRaster(
  nlcd_masked,
  file.path(working.directory, sub_folder5, "NLCD_2019.tif"),
  filetype = 'GTiff',
  datatype = 'INT1U',
  overwrite = TRUE
)

```

# Check-Point
```{r}

# Read in NLCD raster
NLCD_2019 <- rast(paste0(working.directory, "/", sub_folder5, "/", "NLCD_2019.tif"))
NLCD_2019
plot(NLCD_2019)
plot(st_transform(st_as_sf(template), st_crs(5070)), add=T, col="white")

```
