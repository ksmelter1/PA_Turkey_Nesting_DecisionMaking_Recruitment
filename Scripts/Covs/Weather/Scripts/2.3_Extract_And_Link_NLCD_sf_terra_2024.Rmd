---
title: "2.3_Extract_And_Link_NLCD_sf_terra_2024"
output: html_document
date: "2024-08-11"
---

Title:    Disease Modeling Software 
          Script "2.3_Extract_And_Link_NLCD_Data_sf_terra" for Pennsylvania, USA

Authors:  Kristin J. Bondo, 
          Diego Montecino-Latorre, 
          W. David Walter
         
Date:    August 2024

Disclaimer: Any use of trade, firm, or product names is for descriptive purposes 
            only and does not imply endorsement by the U.S. Government.

Description: This script allows the user to extract the mean proportion of each habitat class of the National Land Cover Database at 5 km resolution for each observation 
in the dataset. This is done by extracting the values from a template grid of the study area that has 5 km resolution. The output from this script includes a file with the 
extracted mean proportion of each habitat class of the NLCD that correspond to each observation in the dataset. These values will be used in a subsquent script to link the 
extracted NLCD values to each observation in the dataset. 

This code was written under 
R version 4.3.0 (2023-04-21) -- "Already Tomorrow"
Copyright (C) 2023 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin20 (64-bit)

---

Set-up: Set the working directory on your computer to the location that you would like to store the downloaded files, generate the dataset, and run the models.
```{r}

#For mac
mac_path <- "/your_working_directory"  #Change code to the working directory on your computer
set_working_directory(mac_path)

#For PC
pc_path <- "C:/your_working_directory" #Change code to the working directory on your computer
set_working_directory(pc_path)

# Define working directory
working.directory <- getwd() # Set working directory

```

Set-up: If not done previously, run the project set-up code below to make folders and sub-folders to organize and save data in subsequent scripts.
```{r}

# 0/ Specify overall project folder "Spatial_Disease_Modeling" to contain project files                                           
dir.create(paste0(getwd(),"/Spatial_Disease_Modeling"))

# 1/ Make a sub-folder "1_Raw_Data" to store downloaded raw spatial data 
folder1 <- "Spatial_Disease_Modeling/1_Raw_Data"
dir.create(file.path(working.directory, folder1), recursive=TRUE)

# 2/ Make a sub-folder "2_Spatial_Data_Ready_To_Use" to store the rasters with desired resolution that will be used in the modeling #
folder2 <- "Spatial_Disease_Modeling/2_Spatial_Data_Ready_To_Use"
dir.create(file.path(working.directory, folder2), recursive=TRUE)

# 3/ Make a sub-folder "3_Data_Set_Prep" to store a copy of the cleaned data and extracted spatial data to attach to the dataset #
folder3 <- "Spatial_Disease_Modeling/3_Data_Set_Prep"
dir.create(file.path(working.directory, folder3), recursive=TRUE)

# 4/ Make a sub-folder "4_Run_INLA_Model" to store saved output of INLA models #
folder4 <- "Spatial_Disease_Modeling/4_Run_INLA_Models"
dir.create(file.path(working.directory, folder4), recursive=TRUE)

# 5/ Make a sub-folder "5_Predict_Surface" to store saved output of INLA models #
folder5 <- "Spatial_Disease_Modeling/5_Predict_Surface"
dir.create(file.path(working.directory, folder5), recursive=TRUE)

# 6/ Make a sub-folder "6_Visualize_in_Shiny" to store saved output of INLA models #
folder6 <- "Spatial_Disease_Modeling/6_Visualize_in_Shiny"
dir.create(file.path(working.directory, folder6), recursive=TRUE)

```

Set-Up: Check to see if required libraries are installed. If not, they will be installed.
```{r}

# List of required libraries
required_libraries <- c("foreach", "fasterize", "sf", "exactextractr", "dplyr", "lubridate", "tidyverse", "terra")

# Function to check and install missing libraries
install_if_missing <- function(libraries) {
  for (lib in libraries) {
    if (!require(lib, character.only = TRUE)) {
      install.packages(lib, dependencies = TRUE)
    }
  }
}

# Install libraries
install_if_missing(required_libraries)

```

Set-up: Load packages after they are installed on your machine.
```{r}

library(foreach)
library(fasterize)
library(sf)
library(exactextractr)
library(dplyr)
library(lubridate)
library(tidyverse)
library(terra)

```

1) Read in the cleaned West Nile virus dataset, convert to sf object, and create template grid of study area to extract NLCD data per 5 km grid cell.
```{r}

# Import cleaned data set
base_dir <- "Spatial_Disease_Modeling/3_Data_Set_Prep" # Specify location dataset is located
file_name <- "WNV_data_cleaned.rds"  # Define the file name
file_path <- file.path(working.directory, base_dir, file_name) # Construct the full file path with working directory included
traps.res <- readRDS(file_path) # Read in file

# Create column for year to link data to each assigned year of NLCD data
traps.res$year=year(traps.res$COLLECTED)

# Define the CRS codes
crs.ll <- 4326 # WGS84 (latitude/longitude)

#Convert to sf object
traps.res1=st_as_sf(traps.res, coords = c("LONGITUDE","LATITUDE"), crs = crs.ll)
traps.res <- traps.res1

# Create a template grid of the study area of 5km resolution

states <- tigris::states(resolution = "5m",
                         class = "sf",
                         progress_bar = FALSE)

PA=states[states$STUSPS=="PA",]


template=st_buffer(st_transform(PA, st_crs(6562)), dist = 10000) # template 10 km out of PA borders

# Create raster of specified resolution and projection

# Chosen resolution:
resolution=5000

ex <- as.vector(ext(template))

#Raster and Terra packages generate rasters differently. Raster adjusts ymin whereas terra adjusts ymax. Both adjust xmax. We calculate the extent to be same to how Raster package calculates it.

# Adjust xmax as both Raster and Terra Packages adjust
ncols <- (ex[2] - ex[1]) / resolution
ncols <- floor(ncols)  # Ensure whole number of columns
adjusted_xmax <- ex[1] + (ncols * resolution)  # Adjust xmax

# Adjust ymin as Raster package adjusts
nrows_raster <- (ex[4] - ex[3]) / resolution
nrows_raster <- floor(nrows_raster)  # Ensure whole number of rows
adjusted_ymin_raster <- ex[4] - (nrows_raster * resolution)  # Adjust ymin

#Generate raster to be same extent as raster package
grid.template <- rast(ext(ex[1], adjusted_xmax, adjusted_ymin_raster, ex[4]), 
                      res = resolution,
                      crs = "EPSG:6562") # nad83.2011.pa.north

#Generate raster using default method used by Terra package
#grid.template <-  rast(ext(template), 
                  #res = c(resolution),
                  #crs = "EPSG:6562") #nad83.2011.pa.north

# Code showing default method of how Terra package adjusts ymax 
#nrows_terra <- (ex[4] - ex[3]) / resolution
#nrows_terra <- floor(nrows_terra)  # Ensure whole number of rows
#adjusted_ymax_terra <- ex[3] + (nrows_terra * resolution)  # Adjust ymax

# Move template grid to a spatial object (before it was a empty raster)
gridPolygon <- as.polygons(grid.template)
gridPolygon_sf <- st_as_sf(gridPolygon)
#template1 <- st_as_sf(gridPolygon)[template,]
#template <- template1

# Subset the grid by the box created around PA. Now template is the gridpolygon 
template <- st_intersection(gridPolygon_sf, template)

# Add cell ID
#templatelayer=c(1:nrow(template))
template$cell_number <- seq_len(nrow(template))
#colnames(template)[2]="cell_number"
nrow(template) # 5546 cells.  

# Check point: plot the template, PA
plot(st_geometry(template))
plot(st_geometry(st_transform(PA, st_crs(6562))), add=T, border="red", lwd=2)

```

2) Import NLCD raster for a single year or rasters for multiple years of all land classes 
```{r}

# Code to read in a one NLCD raster for one year.
NLCD_dir <- "Spatial_Disease_Modeling/1_Raw_Data/NLCD_Raw" # Specify location dataset is located
file_name <- "NLCD_2016.tif"  # Define the file name
file_path <- file.path(working.directory, NLCD_dir, file_name) # Construct the full file path with working directory included
nlcd <- rast(file_path)

# Code to read in a multiple NLCD rasters for multiple years. Code in this example uses three years of NLCD raster data.
#files=list.files(path = file.path(working.directory, NLCD_dir))
#files=files[grepl(pattern = ".tif", x = files)] 
#files=files[seq(1,6,2)] # Subset the files to select every second file (2), starting from the first file (1) and ending with the sixth file (6) in the folder. This (2) in this #code skips over associated aux.xml files in folder.
#nlcd <- lapply(files, function(x) rast(file.path(working.directory, NLCD_dir, x)))
#plot(nlcd[[1]])

# Reproject template grid as NLCD raster
template.proj.nlcd=st_transform(template, st_crs(nlcd[[1]])) #The number in brackets is needed if you have multiple years

# Check Point
plot(nlcd[[1]]) #The number in brackets plots the specific layer when you have multiple years
plot(template.proj.nlcd, add=T, border="white")
plot(st_transform(PA, st_crs(nlcd[[1]])), add=T)

```

3) Extract the mean proportion of each NLCD habitat per 5 km grid cell 
```{r}

template.multipolygon=st_cast(st_as_sf(template.proj.nlcd), to = "MULTIPOLYGON")

# Make empty columns with NA to be filled with the NLCD data
template.multipolygon$nlcd=NA

temp=lapply(c(1:nlyr(nlcd)), function(x) template.multipolygon)

# Extract the NLCD values in each 5 km grid cell

# This function allows to use the fast exact_extract to extract the mean proportion of all of the habitat layers at once from the NLCD raster.

out=mclapply(c(1:nlyr((nlcd))), function(x)
  
  exactextractr::exact_extract(nlcd[[x]], 
                               template.multipolygon,
                               include_cell=F), mc.cores = selected.number.of.cores)

prop.nlcd.per.nlcd.layer.all.grids=
  lapply(out, function(x)
    mclapply(x, function(y) 
      y%>%
        group_by(value) %>%
        summarise(total.per.class = n()) %>%
        mutate(prop = total.per.class/sum(total.per.class))))

```


```{r}

#----------------------------------------------------------------------------------------#
# Extract the unique categories present across all nlcd layers across grid cells         #
#----------------------------------------------------------------------------------------#

nlcd.cats.across.PA.across.time=sort(unique(do.call(rbind, lapply(prop.nlcd.per.nlcd.layer.all.grids, function(x) do.call(rbind,x)))$value))

# Assign the proportion of each NLCD class for each 5 km grid cell for the NLCD raster

# Make a matrix to hold the data
nlcd.prop.per.layer.across.grid.cells=matrix(data = 0, ncol = length(nlcd.cats.across.PA.across.time), nrow=length(prop.nlcd.per.nlcd.layer.all.grids[[1]]))

colnames(nlcd.prop.per.layer.across.grid.cells)=nlcd.cats.across.PA.across.time

nlcd.prop.per.layer.across.grid.cells=lapply(1:length(prop.nlcd.per.nlcd.layer.all.grids), function(x) nlcd.prop.per.layer.across.grid.cells)


# Fill the values of the proportions of each nlcd catetgory for each grid cell of the NLCD raster
for(i in 1: length(nlcd.prop.per.layer.across.grid.cells)){
  
  for(j in 1: nrow(nlcd.prop.per.layer.across.grid.cells[[1]])){ 
    nlcd.prop.per.layer.across.grid.cells[[i]][j,
                                               
                                               match(as.character(prop.nlcd.per.nlcd.layer.all.grids[[i]][[j]]$value), colnames(nlcd.prop.per.layer.across.grid.cells[[i]]))]=
      
      prop.nlcd.per.nlcd.layer.all.grids[[i]][[j]]$prop
  }
}

#saveRDS(nlcd.prop.per.layer.across.grid.cells, "~/Spatial_Disease_Modeling/3_Data_Set_Prep/nlcd_prop_per_grid_all_nlcd_layers.RDS")


for(i in 1: length(nlcd.prop.per.layer.across.grid.cells)){
  
  rownames(nlcd.prop.per.layer.across.grid.cells[[i]])=c(1:nrow(nlcd.prop.per.layer.across.grid.cells[[i]]))}


```


4) Extract the corresponding proportions of NLCD land classes for each observation by finding the NLCD layer that corresponds to each grid cell.
```{r}

#Specify the year of the NLCD layer or layers 
names(nlcd.prop.per.layer.across.grid.cells)<-c(2019)  # This script uses "NLCD_2019.tif" for year 2019. 

#Code for Multiple Years
#names(nlcd.prop.per.layer.across.grid.cells)<-c(2013, 2016, 2019) # Example here shows years 2013, 2016, and 2019 if there were three years of NLCD raster data for example.

# Transform traps.res to the same CRS as template.proj.nlcd
traps.res <- st_transform(traps.res, crs = st_crs(template.proj.nlcd))

# Perform a spatial join using st_intersects
traps.res <- st_join(traps.res, template.proj.nlcd, join = st_intersects)

# Convert `template.proj.nlcd` to a SpatVector if not already
template_projj <- vect(template.proj.nlcd)

# Ensure both objects are in the same CRS
template_projj <- project(template_projj, crs(traps.res))

# Convert `traps_res_sf` to SpatVector
traps_res_vec <- vect(traps.res)

# For each observation in traps_res_vec, extract the cell numbers or IDs from `template_projj` 
extracted <- terra::extract(template_projj, traps_res_vec)

# Check and ensure extracted data contains cell numbers or IDs
traps.res$grid_id <- extracted$cell_number

# For a single year of NLCD raster, run following lines of code:
# Find the corresponding year index for each trap
nlcd_index_for_each_trap <- rep(1, nrow(traps.res)) # Since only have data for 2019, always return the index for 2019 year of NLCD raster data.

# Extract NLCD proportions for each trap based on the index for the year 2019
nlcd_per_trap <- lapply(1:nrow(traps.res), function(x) {
 grid_id <- as.numeric(traps.res[x, ]$grid_id)
 nlcd.prop.per.layer.across.grid.cells[[1]][grid_id, ]
})

# For multiple years of NLCD raster, run following lines of code:
#Find the corresponding year index for each trap
#nlcd_index_for_each_trap <- lapply(1:nrow(traps.res), function(x) {
#year <- as.numeric(traps.res[x, ]$year)
#which(years %in% year)
#})

#nlcd_index_for_each <- unlist(nlcd_index_for_each_trap, use.names = FALSE)

# Make a list with the corresponding NLCD proportions per layer per year (For more than one year of NLCD data)
#nlcd_per_trap <- lapply(1:nrow(traps.res), function(x) {
#grid_id <- as.numeric(traps.res[x, ]$grid_id)
#nlcd.prop.per.layer.across.grid.cells[[nlcd_index_for_each[x]]][grid_id, ]
#})

# Save the file with the names of the `nlcd.per.trap`
names(nlcd_per_trap) <- traps.res$Trap_ID

# Make a matrix of the results
nlcd_mat <- do.call(rbind, nlcd_per_trap)

# Turn into a data frame
nlcd_dat <- data.frame(nlcd_mat)

# Make column names of `nlcd_dat` the same as `nlcd_mat`
colnames(nlcd_dat) <- colnames(nlcd_mat)

# Assign unique ID value of each observation in dataset to link spatial data
nlcd_dat$trap_id <- traps.res$Trap_ID

# Assign date of each observation in dataset to ensure it is linking correctly
nlcd_dat$COLLECTED <- traps.res$COLLECTED

# Save extracted data
file_name <- "nlcd_all_traps.rds" # Specify file name for saved file
output_file <- file.path(working.directory, base_dir, file_name) # Construct the full path for the output file
saveRDS(nlcd, output_file) # Save the RDS file

```


